#!/usr/bin/env bash
set -euo pipefail

SOURCE_PATH="${BASH_SOURCE[0]}"
if command -v realpath >/dev/null 2>&1; then
  SOURCE_PATH="$(realpath "$SOURCE_PATH")"
elif command -v readlink >/dev/null 2>&1; then
  if readlink -f "$SOURCE_PATH" >/dev/null 2>&1; then
    SOURCE_PATH="$(readlink -f "$SOURCE_PATH")"
  else
    SOURCE_PATH="$(python3 - <<'PY'
import os, sys
path = sys.argv[1]
print(os.path.realpath(path))
PY
"$SOURCE_PATH")"
  fi
fi

ROOT_DIR="$(cd "$(dirname "$SOURCE_PATH")/.." && pwd)"

if [[ -x "${ROOT_DIR}/target/release/stratuscode" ]]; then
  exec "${ROOT_DIR}/target/release/stratuscode" "$@"
fi

if [[ -x "${ROOT_DIR}/target/debug/stratuscode" ]]; then
  exec "${ROOT_DIR}/target/debug/stratuscode" "$@"
fi

exec env RUSTFLAGS="-Awarnings" cargo run --quiet --manifest-path "${ROOT_DIR}/crates/stratuscode-cli/Cargo.toml" -- "$@"
